<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–õ–∞–±–∏—Ä–∏–Ω—Ç Blockly ‚Äî 50 —É—Ä–æ–≤–Ω–µ–π (RU)</title>

  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/javascript.min.js"></script>
  <script src="https://unpkg.com/blockly/msg/ru.js"></script>

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --muted:#6b7280;
      --text:#111827;
      --shadow: 0 8px 24px rgba(17,24,39,.10);
      --purple:#7c3aed;
      --purple2:#8b5cf6;
      --btn:#7c3aed;
      --btnHover:#6d28d9;
      --green:#10b981;
      --red:#ef4444;
      --amber:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow:auto;
    }
    .wrap{
      height:100dvh;
      height:100svh;
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap: 18px;
      padding: 18px;
      padding-left: max(18px, env(safe-area-inset-left));
      padding-right: max(18px, env(safe-area-inset-right));
      padding-top: max(18px, env(safe-area-inset-top));
      padding-bottom: max(18px, env(safe-area-inset-bottom));
      min-height:0;
    }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-height:0;
      overflow:auto;
      display:flex;
      flex-direction:column;
    }
    .head{
      padding: 18px 18px 12px 18px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .head h1, .head h2{ margin:0; font-size: 20px; line-height:1.2; }
    .sub{ margin-top:6px; font-size: 13px; color: var(--muted); line-height:1.35; }
    .headRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .select{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 13px;
      min-width: 240px;
      cursor:pointer;
    }
    .starsBadge{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      user-select:none;
    }
    .starsBadge span{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing: .5px;
    }
    .leftBody{
      padding: 18px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-height:0;
    }
    .stage{
      flex: 1 1 auto;
      min-height: 260px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--border);
      border-radius: 14px;
      background: #f9fafb;
    }
    canvas{ width: 100%; max-width: 520px; height: auto; display:block; }
    .controls{ display:flex; gap:10px; align-items:center; }
    .run{
      flex: 1 1 auto;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      border:none; cursor:pointer;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 14px;
      color:#fff;
      background: linear-gradient(180deg, var(--btn), var(--purple2));
      box-shadow: 0 10px 18px rgba(124,58,237,.20);
      user-select:none;
    }
    .run:hover{ background: linear-gradient(180deg, var(--btnHover), var(--purple)); }
    .iconBtn{
      width: 46px; height: 46px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:grid; place-items:center;
      font-size: 16px;
      user-select:none;
    }
    .iconBtn:hover{ background:#f9fafb; }

    .miniRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .msg{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:flex-start;
      line-height:1.35;
    }
    .msg strong{ color: var(--text); }
    .msg.ok{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.08); color:#065f46; }
    .msg.err{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); color:#7f1d1d; }
    .msg.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08); color:#78350f; }

    .rightBody{ position:relative; flex: 1 1 auto; min-height:0; }
    #blocklyDiv{ position:absolute; inset:0; touch-action: none; }
    .footerHint{
      padding: 10px 14px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      background:#fff;
    }

    #errorBanner{
      position:fixed;
      left:18px; right:18px; bottom:18px;
      background: rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.35);
      color:#7f1d1d;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 99999;
      font-size: 13px;
      line-height:1.35;
    }
    #errorBanner code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    .modal{
      position:fixed;
      inset:0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalCard{
      width:min(980px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:auto;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modalHead b{ font-size: 16px; }
    .modalBody{ padding: 14px 16px; color: var(--text); }
    .modalActions{
      padding: 14px 16px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-size: 13px;
    }
    .btn.primary{
      border-color: rgba(124,58,237,.35);
      background: rgba(124,58,237,.10);
      color: #4c1d95;
    }
    .btn.good{
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.10);
      color:#065f46;
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      color:#7f1d1d;
    }
    .btn.locked{
      opacity: .75;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 10px;
    }
    .field label{ font-size: 12px; color: var(--muted); }
    .input, .textarea{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 13px;
      outline:none;
      width:100%;
      background:#fff;
    }
    .textarea{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      min-height: 220px;
      resize: vertical;
    }

    @media (max-width: 980px){
      body{overflow:auto}
      .wrap{
        grid-template-columns: 1fr;
        height:auto;
        min-height: 100dvh;
        min-height: 100svh;
      }
      .head{ gap: 10px; }
      .headRight{ justify-content:flex-start; }
      .select{ min-width: 200px; width: 100%; }
      .rightBody{
        height: 60vh;
        min-height: 420px;
      }
      .stage{ min-height: 220px; }
    }
    @media (max-width: 520px){
      .wrap{ padding: 12px; padding-left: max(12px, env(safe-area-inset-left)); padding-right: max(12px, env(safe-area-inset-right)); }
      .head{ padding: 14px 14px 10px 14px; }
      .leftBody{ padding: 14px; }
      .rightBody{ height: 58vh; min-height: 380px; }
      .controls{ gap: 8px; }
      .iconBtn{ width: 44px; height: 44px; }
      .run{ padding: 14px 12px; }
      .pill{ font-size: 11px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="card">
      <div class="head">
        <div>
          <h1 id="leftTitle">–õ–∞–±–∏—Ä–∏–Ω—Ç</h1>
          <div class="sub" id="leftSub">–ü—Ä–æ—Å—Ç–æ–π –ø—É—Ç—å ‚Äî –¥–æ–±–µ—Ä–∏—Å—å –¥–æ —Ü–µ–ª–∏!</div>
        </div>

        <div class="headRight">
          <select class="select" id="levelSelect" title="–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è"></select>

          <div class="starsBadge" title="–õ—É—á—à–∞—è –æ—Ü–µ–Ω–∫–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å">
            ‚≠ê <span id="starsText">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
          </div>

          <!-- –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã—Ç–æ: PIN —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ -->
          <button class="btn locked" id="editorOpenBtn" title="–†–µ–¥–∞–∫—Ç–æ—Ä —É—Ä–æ–≤–Ω–µ–π (—Ç–æ–ª—å–∫–æ —É—á–∏—Ç–µ–ª—å)">üîí –†–µ–¥–∞–∫—Ç–æ—Ä</button>
        </div>
      </div>

      <div class="leftBody">
        <div class="miniRow">
          <div class="pill" id="goalPill">–ó–∞–¥–∞–Ω–∏–µ: ‚Äî</div>
          <div class="pill" id="limitPill">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: ‚Äî</div>
          <div class="pill" id="statusPill">–°–æ—Å—Ç–æ—è–Ω–∏–µ: –ì–æ—Ç–æ–≤–æ</div>
          <div class="pill" id="minPill">–ú–∏–Ω–∏–º—É–º: ‚Äî</div>
        </div>

        <div class="stage">
          <canvas id="canvas" width="520" height="520"></canvas>
        </div>

        <div class="controls">
          <button class="run" id="runBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥</button>
          <button class="iconBtn" id="stepBtn" title="–®–∞–≥">‚è≠</button>
          <button class="iconBtn" id="resetBtn" title="–°–±—Ä–æ—Å">‚Ü∫</button>
        </div>

        <div class="msg" id="msg">
          <div>‚ÑπÔ∏è</div>
          <div><strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –ø–µ—Ä–µ—Ç–∞—â–∏ –±–ª–æ–∫–∏ –≤ –ø–æ–ª–µ —Å–ø—Ä–∞–≤–∞ –∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥¬ª.</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="head">
        <div>
          <h2>–¢–≤–æ–π –∫–æ–¥</h2>
          <div class="sub">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –±–ª–æ–∫–∏, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É.</div>
        </div>
        <div class="headRight">
          <div class="pill" id="blocksInfo">–ë–ª–æ–∫–æ–≤: 0</div>
          <div class="pill" id="actionsInfo">–ö–æ–º–∞–Ω–¥: 0</div>
          <button class="btn" id="showCodeBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JavaScript">–ö–æ–¥</button>
        </div>
      </div>
      <div class="rightBody">
        <div id="blocklyDiv"></div>
      </div>
      <div class="footerHint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ/—É–º–µ–Ω—å—à–µ–Ω–∏–µ ‚Äî –∫–æ–ª–µ—Å–æ –º—ã—à–∏ –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –∑—É–º–∞.</div>
    </section>
  </div>

  <div id="errorBanner"></div>

  <div class="modal" id="finishModal">
    <div class="modalCard">
      <div class="modalHead">
        <b>üèÜ –¢—ã –ø—Ä–æ—à—ë–ª –≤—Å–µ —É—Ä–æ–≤–Ω–∏!</b>
        <button class="btn" id="finishCloseBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody">
        –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ<br><br>
        –¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å:
        <ul>
          <li>–ø–µ—Ä–µ–ø—Ä–æ–π—Ç–∏ —É—Ä–æ–≤–Ω–∏ –∏ —É–ª—É—á—à–∏—Ç—å –æ—Ü–µ–Ω–∫—É (–∑–≤—ë–∑–¥—ã)</li>
          <li>—É—á–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É—Ä–æ–≤–Ω–∏ —á–µ—Ä–µ–∑ PIN-—Ä–µ–¥–∞–∫—Ç–æ—Ä</li>
        </ul>
      </div>
      <div class="modalActions">
        <button class="btn good" id="finishReplayBtn">–ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏ —Å–Ω–∞—á–∞–ª–∞</button>
      </div>
    </div>
  </div>

  <div class="modal" id="editorModal">
    <div class="modalCard">
      <div class="modalHead">
        <b>üß© –†–µ–¥–∞–∫—Ç–æ—Ä —É—Ä–æ–≤–Ω–µ–π (—É—á–∏—Ç–µ–ª—å)</b>
        <button class="btn" id="editorCloseBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div>
            <div class="field">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input class="input" id="edTitle" />
            </div>
            <div class="field">
              <label>–ó–∞–¥–∞–Ω–∏–µ</label>
              <input class="input" id="edGoal" />
            </div>
            <div class="field">
              <label>–ü–æ–¥—Å–∫–∞–∑–∫–∞</label>
              <input class="input" id="edHint" />
            </div>

            <div class="field">
              <label>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</label>
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <label style="display:flex;gap:8px;align-items:center;font-size:13px;">
                  <input type="checkbox" id="edRequireLoop" />
                  –¢—Ä–µ–±–æ–≤–∞—Ç—å —Ü–∏–∫–ª
                </label>

                <span style="font-size:13px;color:var(--muted);">–ú–∞–∫—Å. –±–ª–æ–∫–æ–≤:</span>
                <input class="input" id="edMaxBlocks" type="number" min="1" style="width:110px" />

                <span style="font-size:13px;color:var(--muted);">–ú–∞–∫—Å. –∫–æ–º–∞–Ω–¥:</span>
                <input class="input" id="edMaxCommands" type="number" min="1" style="width:110px" />

                <span style="font-size:13px;color:var(--muted);">–ü–∞—Ä (–∫–æ–º–∞–Ω–¥):</span>
                <input class="input" id="edParActions" type="number" min="1" style="width:110px" />
              </div>
              <div style="margin-top:8px;color:var(--muted);font-size:12px;">
                –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è: <b>–º–∞–∫—Å. –∫–æ–º–∞–Ω–¥ –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç ‚â• —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞</b> (solver).
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
              <button class="btn good" id="edSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
              <button class="btn" id="edRecalcBtn" title="–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –º–∏–Ω–∏–º—É–º/–ø–∞—Ä/–ª–∏–º–∏—Ç—ã">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏</button>
              <button class="btn danger" id="edResetOverridesBtn" title="–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∞–≤–∫–∏ —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∞–≤–∫–∏</button>
            </div>

            <hr style="border:none;border-top:1px solid var(--border); margin: 14px 0;">

            <!-- ‚úÖ –°–º–µ–Ω–∞ PIN –ø—Ä—è–º–æ –≤ —Ä–µ–∂–∏–º–µ —É—á–∏—Ç–µ–ª—è -->
            <div class="field">
              <label>PIN —É—á–∏—Ç–µ–ª—è</label>
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <button class="btn primary" id="changePinBtn">–°–º–µ–Ω–∏—Ç—å PIN</button>
                <span style="font-size:12px;color:var(--muted);">
                  PIN —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —ç—Ç–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (–≤ –±—Ä–∞—É–∑–µ—Ä–µ).
                </span>
              </div>
            </div>

            <hr style="border:none;border-top:1px solid var(--border); margin: 14px 0;">

            <div class="field">
              <label>–≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç JSON (–¥–ª—è —É—á–∏—Ç–µ–ª—è)</label>
              <textarea class="textarea" id="edJson"></textarea>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                <button class="btn" id="edExportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn primary" id="edImportBtn">–ò–º–ø–æ—Ä—Ç</button>
              </div>
            </div>
          </div>

          <div>
            <div class="field">
              <label>–°–µ—Ç–∫–∞ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞</label>
              <textarea class="textarea" id="edGrid"></textarea>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                <button class="btn" id="edPreviewBtn">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
              </div>
              <div style="font-size:12px;color:var(--muted);margin-top:8px;">
                –°–∏–º–≤–æ–ª—ã: <code>#</code> —Å—Ç–µ–Ω–∞, <code>.</code> –ø—É—Ç—å, <code>S</code> —Å—Ç–∞—Ä—Ç, <code>G</code> —Ü–µ–ª—å.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modalActions">
        <button class="btn" id="editorHelpBtn">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç PIN</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   Teacher PIN (—Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ä–∞–∑)
========================= */
const TEACHER_PIN_KEY = "blockly_maze_teacher_pin_v1";
const DEFAULT_TEACHER_PIN = "2580";

function getTeacherPin(){
  const stored = localStorage.getItem(TEACHER_PIN_KEY);
  return (stored && String(stored).trim().length >= 4) ? String(stored) : DEFAULT_TEACHER_PIN;
}
function requireTeacher(){
  const pin = prompt("–í–≤–µ–¥–∏—Ç–µ PIN —É—á–∏—Ç–µ–ª—è:");
  if(pin === null) return false;
  if(String(pin) === getTeacherPin()) return true;
  alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN.");
  return false;
}
function setTeacherPin(newPin){
  localStorage.setItem(TEACHER_PIN_KEY, String(newPin));
}

/* =========================
   Error UI
========================= */
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function showFatalError(err){
  const b = document.getElementById("errorBanner");
  b.style.display = "block";
  const msg = (err && err.stack) ? err.stack : String(err);
  b.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:<br><code>${escapeHtml(msg)}</code>`;
}
window.addEventListener("error", (e)=>{ showFatalError(e.error || e.message || e); });

/* =========================
   Storage
========================= */
const STORAGE_KEY = "blockly_maze_progress_v6";
const CUSTOM_LEVELS_KEY = "blockly_maze_custom_levels_v6";
const OVERRIDES_KEY = "blockly_maze_level_overrides_v6";

function loadProgress() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { unlocked: 1, stars: {}, finishedAll: false };
    const p = JSON.parse(raw);
    return { unlocked: Number(p.unlocked || 1), stars: p.stars || {}, finishedAll: !!p.finishedAll };
  } catch { return { unlocked: 1, stars: {}, finishedAll: false }; }
}
function saveProgress(p) { localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }
function getBestStars(levelId) { const p = loadProgress(); return Number(p.stars[String(levelId)] || 0); }
function setBestStars(levelId, stars) {
  const p = loadProgress();
  const key = String(levelId);
  const prev = Number(p.stars[key] || 0);
  if (stars > prev) p.stars[key] = stars;
  saveProgress(p);
}
function unlockNextLevel(currentId) {
  const p = loadProgress();
  const next = currentId + 1;
  if (next > p.unlocked) p.unlocked = next;
  const total = getAllLevels().length;
  if (p.unlocked > total) p.unlocked = total;
  saveProgress(p);
}
function markFinishedAll() { const p = loadProgress(); p.finishedAll = true; saveProgress(p); }

function loadCustomLevels() {
  try {
    const raw = localStorage.getItem(CUSTOM_LEVELS_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}
function saveCustomLevels(levels) { localStorage.setItem(CUSTOM_LEVELS_KEY, JSON.stringify(levels)); }

function loadOverrides(){
  try{
    const raw = localStorage.getItem(OVERRIDES_KEY);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    return (obj && typeof obj === "object") ? obj : {};
  }catch{ return {}; }
}
function saveOverrides(map){ localStorage.setItem(OVERRIDES_KEY, JSON.stringify(map)); }
function clearOverrideFor(id){
  const m = loadOverrides();
  delete m[String(id)];
  saveOverrides(m);
}

/* =========================
   Levels base (50)
========================= */
const TUTOR_LEVELS = [
  { id: 1,  title:"–£—Ä–æ–≤–µ–Ω—å 1",  subtitle:"–°–¥–µ–ª–∞–π –æ–¥–∏–Ω —à–∞–≥ –≤–ø–µ—Ä—ë–¥", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–ò—Å–ø–æ–ª—å–∑—É–π –±–ª–æ–∫ ¬´–≤–ø–µ—Ä—ë–¥¬ª.", requireLoop:false, maxBlocks:3,  toolbox:"move",
    grid:["#####","#S.G#","#####"] },
  { id: 2,  title:"–£—Ä–æ–≤–µ–Ω—å 2",  subtitle:"–ù–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–ü–æ—Å—Ç–∞–≤—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ ¬´–≤–ø–µ—Ä—ë–¥¬ª.", requireLoop:false, maxBlocks:5,  toolbox:"move",
    grid:["#######","#S...G#","#######"] },
  { id: 3,  title:"–£—Ä–æ–≤–µ–Ω—å 3",  subtitle:"–ü–µ—Ä–≤—ã–π –ø–æ–≤–æ—Ä–æ—Ç", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–≤–æ—Ä–æ—Ç—ã.", requireLoop:false, maxBlocks:9, toolbox:"turn",
    grid:["#######","#S#...#","#.#.#G#","#...#.#","#######"] },
  { id: 4,  title:"–£—Ä–æ–≤–µ–Ω—å 4",  subtitle:"–î–≤–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–ö–æ–º–±–∏–Ω–∏—Ä—É–π ¬´–≤–ø–µ—Ä—ë–¥¬ª –∏ –ø–æ–≤–æ—Ä–æ—Ç—ã.", requireLoop:false, maxBlocks:12, toolbox:"turn",
    grid:["########","#S#....#","#.#.##.#","#...#G.#","########"] },
  { id: 5,  title:"–£—Ä–æ–≤–µ–Ω—å 5",  subtitle:"–ú–∞–ª–µ–Ω—å–∫–∏–π –ª–∞–±–∏—Ä–∏–Ω—Ç", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–î—É–º–∞–π –æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.", requireLoop:false, maxBlocks:14, toolbox:"turn",
    grid:["#########","#S#...#G#","#.#.#.#.#","#...#...#","#########"] },
  { id: 6,  title:"–£—Ä–æ–≤–µ–Ω—å 6",  subtitle:"–ö–æ—Ä–∏–¥–æ—Ä —Å –ø–æ–≤–æ—Ä–æ—Ç–æ–º", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–°–Ω–∞—á–∞–ª–∞ –≤–ø–µ—Ä—ë–¥, –∑–∞—Ç–µ–º –ø–æ–≤–µ—Ä–Ω–∏.", requireLoop:false, maxBlocks:16, toolbox:"turn",
    grid:["#########","#S....#.#","#####.#.#","#.....#G#","#########"] },
  { id: 7,  title:"–£—Ä–æ–≤–µ–Ω—å 7",  subtitle:"–î–ª–∏–Ω–Ω—ã–π –ø—É—Ç—å", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–°–∫–æ—Ä–æ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è —Ü–∏–∫–ª üôÇ", requireLoop:false, maxBlocks:18, toolbox:"turn",
    grid:["###########","#S........#","#####.#####","#........G#","###########"] },
  { id: 8,  title:"–£—Ä–æ–≤–µ–Ω—å 8",  subtitle:"–î–≤–∞ –∫–æ—Ä–∏–¥–æ—Ä–∞", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–°–ª–µ–¥–∏ –∑–∞ —Å—Ç–µ–Ω–∞–º–∏ –∏ –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏.", requireLoop:false, maxBlocks:20, toolbox:"turn",
    grid:["###########","#S#.......#","#.#.#####.#","#...#...#G#","#####.#.#.#","#.......#.#","###########"] },
  { id: 9,  title:"–£—Ä–æ–≤–µ–Ω—å 9",  subtitle:"–ì–æ—Ç–æ–≤–∏–º—Å—è –∫ —Ü–∏–∫–ª–∞–º", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–ë—É–¥–µ—Ç —É–¥–æ–±–Ω–µ–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —à–∞–≥–∏.", requireLoop:false, maxBlocks:22, toolbox:"turn",
    grid:["############","#S.........#","######.#####","#......#...#","#.######.#G#","#........#.#","############"] },
  { id: 10, title:"–£—Ä–æ–≤–µ–Ω—å 10", subtitle:"–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞", goal:"–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.", hint:"–°–∫–æ—Ä–æ —Ü–∏–∫–ª —Å—Ç–∞–Ω–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º.", requireLoop:false, maxBlocks:22, toolbox:"turn",
    grid:["############","#S..#......#","#.#.#.####.#","#.#...#..#.#","#.#####..#G#","#..........#","############"] },
];

function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function generateMazeAscii(sizeOdd, seed){
  const rand = mulberry32(seed);
  const N = sizeOdd;
  const g = Array.from({length:N}, () => Array.from({length:N}, () => "#"));
  function inBounds(x,y){ return x>0 && y>0 && x<N-1 && y<N-1; }
  function shuffledDirs(){
    const dirs = [[0,-2],[2,0],[0,2],[-2,0]];
    for(let i=dirs.length-1;i>0;i--){
      const j = Math.floor(rand()*(i+1));
      [dirs[i],dirs[j]]=[dirs[j],dirs[i]];
    }
    return dirs;
  }
  const stack = [[1,1]];
  g[1][1] = ".";
  while(stack.length){
    const [x,y] = stack[stack.length-1];
    const dirs = shuffledDirs();
    let moved = false;
    for(const [dx,dy] of dirs){
      const nx = x+dx, ny = y+dy;
      if(inBounds(nx,ny) && g[ny][nx] === "#"){
        g[y+dy/2][x+dx/2] = ".";
        g[ny][nx] = ".";
        stack.push([nx,ny]);
        moved = true;
        break;
      }
    }
    if(!moved) stack.pop();
  }
  g[1][1] = "S";
  g[N-2][N-2] = "G";
  return g.map(r=>r.join(""));
}
function buildGeneratedLevels(){
  const levels = [];
  let id = 11;
  const groups = [
    {count:10, size:11, toolbox:"repeat", requireLoop:true,  maxBlocksBase:14},
    {count:10, size:13, toolbox:"if",     requireLoop:true,  maxBlocksBase:16},
    {count:10, size:15, toolbox:"if",     requireLoop:true,  maxBlocksBase:18},
    {count:10, size:17, toolbox:"while",  requireLoop:true,  maxBlocksBase:20},
  ];
  const seedBase = 9001;
  for(const g of groups){
    for(let i=0;i<g.count;i++){
      const lvlId = id++;
      const maze = generateMazeAscii(g.size, seedBase + lvlId*101);
      const k = i / Math.max(1,(g.count-1));
      const maxBlocks = Math.max(10, Math.round(g.maxBlocksBase + k*4));
      levels.push({
        id: lvlId,
        title: `–£—Ä–æ–≤–µ–Ω—å ${lvlId}`,
        subtitle:
          (lvlId<=20) ? "–ò—Å–ø–æ–ª—å–∑—É–π —Ü–∏–∫–ª, —á—Ç–æ–±—ã —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∫–æ–¥" :
          (lvlId<=30) ? "–ò—Å–ø–æ–ª—å–∑—É–π —É—Å–ª–æ–≤–∏—è –∏ —Ü–∏–∫–ª" :
          (lvlId<=40) ? "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π —Ä–µ—à–µ–Ω–∏–µ" :
                        "–ú–∞—Å—Ç–µ—Ä: —Ü–∏–∫–ª—ã + —É—Å–ª–æ–≤–∏—è",
        goal:
          (lvlId<=20) ? "–ü—Ä–æ–π–¥–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π —Ü–∏–∫–ª." :
          (lvlId<=30) ? "–ü—Ä–æ–π–¥–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–π —Ü–∏–∫–ª –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ø—É—Ç–∏." :
          (lvlId<=40) ? "–ü—Ä–æ–π–¥–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç. –£–ª–æ–∂–∏—Å—å –≤ –ª–∏–º–∏—Ç—ã." :
                        "–ü—Ä–æ–π–¥–∏ —Å–ª–æ–∂–Ω—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç.",
        hint:
          (lvlId<=20) ? "–ì–¥–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è —à–∞–≥–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π ¬´–ø–æ–≤—Ç–æ—Ä–∏—Ç—å¬ª." :
          (lvlId<=30) ? "–ò—Å–ø–æ–ª—å–∑—É–π ¬´–µ—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ —Å–≤–æ–±–æ–¥–Ω–æ¬ª, —á—Ç–æ–±—ã –Ω–µ –≤—Ä–µ–∑–∞—Ç—å—Å—è." :
          (lvlId<=40) ? "–ö–æ–º–±–∏–Ω–∏—Ä—É–π —Ü–∏–∫–ª + —É—Å–ª–æ–≤–∏—è." :
                        "–ò—Å–ø–æ–ª—å–∑—É–π ¬´–ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ–∫–∞ –Ω–µ —Ü–µ–ª—å¬ª.",
        requireLoop: g.requireLoop,
        maxBlocks,
        toolbox: g.toolbox,
        grid: maze
      });
    }
  }
  return levels;
}
const GENERATED_LEVELS = buildGeneratedLevels();

/* =========================
   Blockly locale (safe)
========================= */
try{
  if (Blockly && typeof Blockly.setLocale === "function" && Blockly.Msg) Blockly.setLocale(Blockly.Msg);
}catch{}

/* =========================
   Custom blocks (RU)
========================= */
Blockly.defineBlocksWithJsonArray([
  { type:"maze_move_forward", message0:"–≤–ø–µ—Ä—ë–¥", previousStatement:null, nextStatement:null, colour:"#7c3aed" },
  { type:"maze_turn_left", message0:"–ø–æ–≤–µ—Ä–Ω—É—Ç—å –Ω–∞–ª–µ–≤–æ", previousStatement:null, nextStatement:null, colour:"#10b981" },
  { type:"maze_turn_right", message0:"–ø–æ–≤–µ—Ä–Ω—É—Ç—å –Ω–∞–ø—Ä–∞–≤–æ", previousStatement:null, nextStatement:null, colour:"#10b981" },
  {
    type:"maze_repeat_times",
    message0:"–ø–æ–≤—Ç–æ—Ä–∏—Ç—å %1 —Ä–∞–∑ %2",
    args0:[
      { type:"field_number", name:"COUNT", value:4, min:1, max:999, precision:1 },
      { type:"input_statement", name:"DO" }
    ],
    previousStatement:null, nextStatement:null, colour:"#f59e0b"
  },
  {
    type:"maze_if_path",
    message0:"–µ—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ —Å–≤–æ–±–æ–¥–Ω–æ —Ç–æ %1",
    args0:[ {type:"input_statement", name:"DO"} ],
    previousStatement:null, nextStatement:null, colour:"#f59e0b"
  },
  {
    type:"maze_until_goal",
    message0:"–ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ–∫–∞ –Ω–µ —Ü–µ–ª—å %1",
    args0:[ {type:"input_statement", name:"DO"} ],
    previousStatement:null, nextStatement:null, colour:"#f59e0b"
  }
]);

if(!Blockly.JavaScript) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä Blockly.JavaScript.");

Blockly.JavaScript.forBlock["maze_move_forward"] = ()=> "actions.push({t:'F'});\n";
Blockly.JavaScript.forBlock["maze_turn_left"]    = ()=> "actions.push({t:'L'});\n";
Blockly.JavaScript.forBlock["maze_turn_right"]   = ()=> "actions.push({t:'R'});\n";
Blockly.JavaScript.forBlock["maze_repeat_times"] = (block)=>{
  const n = Number(block.getFieldValue("COUNT") || 1);
  const inner = Blockly.JavaScript.statementToCode(block, "DO");
  return `for (let i=0;i<${Math.max(1,n)};i++) { api.guard();\n${inner}}\n`;
};
Blockly.JavaScript.forBlock["maze_if_path"] = (block)=>{
  const inner = Blockly.JavaScript.statementToCode(block, "DO");
  return `api.guard();\nif (api.isPathForward()) {\n${inner}}\n`;
};
Blockly.JavaScript.forBlock["maze_until_goal"] = (block)=>{
  const inner = Blockly.JavaScript.statementToCode(block, "DO");
  return `while (!api.isAtGoal()) {\napi.guard();\n${inner}}\n`;
};

/* =========================
   Toolbox
========================= */
function toolboxXmlFor(level){
  const mode = level.toolbox || "turn";
  const move = `
    <category name="–î–≤–∏–∂–µ–Ω–∏–µ" colour="#7c3aed">
      <block type="maze_move_forward"></block>
    </category>`;
  const turns = `
    <category name="–ü–æ–≤–æ—Ä–æ—Ç—ã" colour="#10b981">
      <block type="maze_turn_left"></block>
      <block type="maze_turn_right"></block>
    </category>`;
  const loops = `
    <category name="–¶–∏–∫–ª—ã" colour="#f59e0b">
      <block type="maze_repeat_times"></block>
      <block type="maze_until_goal"></block>
    </category>`;
  const cond = `
    <category name="–£—Å–ª–æ–≤–∏—è" colour="#f59e0b">
      <block type="maze_if_path"></block>
    </category>`;
  let xml = `<xml>`;
  if(mode==="move") xml += move;
  else if(mode==="turn") xml += move + turns;
  else if(mode==="repeat") xml += move + turns + loops;
  else if(mode==="if") xml += move + turns + loops + cond;
  else xml += move + turns + loops + cond;
  xml += `</xml>`;
  return xml;
}
function toolboxXmlToDom(xmlText){
  try{ if (Blockly.utils?.xml?.textToDom) return Blockly.utils.xml.textToDom(xmlText); }catch{}
  return Blockly.Xml.textToDom(xmlText);
}

/* =========================
   Solver (shortest commands)
========================= */
const DIRS = ["N","E","S","W"];
const VEC = { N:[0,-1], E:[1,0], S:[0,1], W:[-1,0] };

function parseGrid(level){
  const g = level.grid.map(r=>r.split(""));
  const H = g.length, W = g[0].length;
  let S=null,G=null;
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      if(g[y][x]==="S") S={x,y};
      if(g[y][x]==="G") G={x,y};
    }
  }
  if(!S || !G) return null;
  return {g,W,H,S,G};
}
function shortestCommands(level){
  const p = parseGrid(level);
  if(!p) return Infinity;
  const {g,W,H,S,G} = p;
  const inb=(x,y)=>x>=0&&y>=0&&x<W&&y<H;
  const free=(x,y)=>inb(x,y)&&g[y][x]!=="#";

  const start = {x:S.x,y:S.y,d:"E"};
  const q = [];
  const dist = new Map();
  const key = (x,y,d)=>`${x},${y},${d}`;
  q.push(start);
  dist.set(key(start.x,start.y,start.d), 0);

  while(q.length){
    const cur = q.shift();
    const cd = dist.get(key(cur.x,cur.y,cur.d));
    if(cur.x===G.x && cur.y===G.y) return cd;

    { // L
      const nd = DIRS[(DIRS.indexOf(cur.d)+3)%4];
      const k = key(cur.x,cur.y,nd);
      if(!dist.has(k)){ dist.set(k, cd+1); q.push({x:cur.x,y:cur.y,d:nd}); }
    }
    { // R
      const nd = DIRS[(DIRS.indexOf(cur.d)+1)%4];
      const k = key(cur.x,cur.y,nd);
      if(!dist.has(k)){ dist.set(k, cd+1); q.push({x:cur.x,y:cur.y,d:nd}); }
    }
    { // F
      const [dx,dy]=VEC[cur.d];
      const nx=cur.x+dx, ny=cur.y+dy;
      if(free(nx,ny)){
        const k = key(nx,ny,cur.d);
        if(!dist.has(k)){ dist.set(k, cd+1); q.push({x:nx,y:ny,d:cur.d}); }
      }
    }
  }
  return Infinity;
}

/* =========================
   Overrides + normalize criteria
========================= */
function applyLevelOverrides(level){
  const m = loadOverrides();
  const o = m[String(level.id)];
  if(!o) return level;
  return {...level, ...o};
}
function normalizeCriteria(level){
  const min = shortestCommands(level);
  const minCommands = Number.isFinite(min) ? min : 9999;

  let maxCommands = level.maxCommands;
  if(!Number.isFinite(maxCommands)) {
    const slack = (minCommands<=12) ? 2 : (minCommands<=40) ? 6 : 10;
    maxCommands = minCommands + slack;
  } else {
    maxCommands = Math.max(maxCommands, minCommands);
  }

  let parActions = level.parActions;
  if(!Number.isFinite(parActions)) parActions = Math.max(1, minCommands);
  parActions = Math.max(1, Math.min(parActions, maxCommands));

  return {...level, minCommands, maxCommands, parActions};
}
function getAllLevels(){
  const base = [...TUTOR_LEVELS, ...GENERATED_LEVELS, ...loadCustomLevels()];
  return base.map(l => normalizeCriteria(applyLevelOverrides(l)));
}

/* =========================
   Game + UI
========================= */
const $ = id => document.getElementById(id);
const canvas = $("canvas");
const ctx = canvas.getContext("2d");

let levelIndex = 0;
let grid = [];
let w=0,h=0;
let player = {x:0,y:0,dir:"E"};
let start  = {x:0,y:0,dir:"E"};
let goal   = {x:0,y:0};

let actionsQueue = [];
let ip = 0;
let running = false;
let timer = null;

function setMsg(kind, text){
  const el = $("msg");
  el.classList.remove("ok","err","warn");
  if(kind==="ok") el.classList.add("ok");
  if(kind==="err") el.classList.add("err");
  if(kind==="warn") el.classList.add("warn");
  el.innerHTML = `<div>${kind==="ok"?"‚úÖ":kind==="err"?"‚ö†Ô∏è":kind==="warn"?"üü°":"‚ÑπÔ∏è"}</div><div>${text}</div>`;
}
function setStatus(text){ $("statusPill").textContent = "–°–æ—Å—Ç–æ—è–Ω–∏–µ: " + text; }
function isInside(x,y){ return x>=0 && y>=0 && x<w && y<h; }

const api = {
  _ticks: 0,
  guard(){
    api._ticks++;
    if(api._ticks > 14000) throw new Error("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π. –í–æ–∑–º–æ–∂–Ω–æ, –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª.");
  },
  isPathForward(){
    const [dx,dy] = VEC[player.dir];
    const nx = player.x + dx, ny = player.y + dy;
    return isInside(nx,ny) && grid[ny][nx] !== "#";
  },
  isAtGoal(){ return player.x===goal.x && player.y===goal.y; }
};

const workspace = Blockly.inject("blocklyDiv", {
  toolbox: toolboxXmlToDom(toolboxXmlFor(getAllLevels()[0])),
  trashcan: true,
  zoom: { controls:true, wheel:true, startScale:0.95, maxScale:1.25, minScale:0.55, scaleSpeed:1.1 },
  grid: { spacing: 20, length: 3, colour: "#e5e7eb", snap: true },
  theme: Blockly.Theme.defineTheme("lightMazeTheme", {
    base: Blockly.Themes.Classic,
    componentStyles: {
      workspaceBackgroundColour: "#fafafa",
      toolboxBackgroundColour: "#f3f4f6",
      toolboxForegroundColour: "#111827",
      flyoutBackgroundColour: "#ffffff",
      flyoutForegroundColour: "#111827",
      scrollbarColour: "#d1d5db",
      insertionMarkerColour: "#10b981",
      insertionMarkerOpacity: 0.35
    }
  })
});

function parseLevel(level){
  grid = level.grid.map(r=>r.split(""));
  h = grid.length;
  w = grid[0].length;

  let foundS=false, foundG=false;
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      if(grid[y][x]==="S"){ start={x,y,dir:"E"}; foundS=true; }
      if(grid[y][x]==="G"){ goal={x,y}; foundG=true; }
    }
  }
  if(!foundS || !foundG) throw new Error("–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—Ä–µ–∂–¥—ë–Ω: –Ω–µ –Ω–∞–π–¥–µ–Ω S –∏–ª–∏ G.");
}

function draw(){
  const pad = 16;
  const size = Math.min(canvas.width, canvas.height) - pad*2;
  const cell = Math.floor(size / Math.max(w,h));
  const offX = Math.floor((canvas.width - cell*w)/2);
  const offY = Math.floor((canvas.height - cell*h)/2);

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "#f9fafb";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const px = offX + x*cell, py = offY + y*cell;

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(px,py,cell,cell);

      if(grid[y][x]==="#"){
        ctx.fillStyle = "#e5e7eb";
        ctx.fillRect(px,py,cell,cell);
      }

      ctx.strokeStyle = "#f3f4f6";
      ctx.strokeRect(px+0.5,py+0.5,cell-1,cell-1);

      if(grid[y][x]==="S") {
        ctx.fillStyle = "rgba(124,58,237,.12)";
        ctx.fillRect(px,py,cell,cell);
        ctx.fillStyle = "#6d28d9";
        ctx.font = `${Math.max(10, Math.floor(cell*0.35))}px system-ui`;
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText("S", px+cell/2, py+cell/2);
      }
      if(grid[y][x]==="G") {
        ctx.fillStyle = "rgba(16,185,129,.12)";
        ctx.fillRect(px,py,cell,cell);
        ctx.fillStyle = "#059669";
        ctx.beginPath();
        ctx.arc(px+cell/2, py+cell/2, cell*0.22, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "#ffffff";
        ctx.beginPath();
        ctx.arc(px+cell/2, py+cell/2, cell*0.10, 0, Math.PI*2);
        ctx.fill();
      }
    }
  }

  const cx = offX + player.x*cell + cell/2;
  const cy = offY + player.y*cell + cell/2;
  ctx.save();
  ctx.fillStyle = "#7c3aed";
  ctx.beginPath(); ctx.arc(cx,cy,cell*0.22,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = "#ffffff";
  ctx.beginPath();
  const s = cell*0.20;
  if(player.dir==="N"){ ctx.moveTo(cx, cy - s); ctx.lineTo(cx - s*0.75, cy + s*0.7); ctx.lineTo(cx + s*0.75, cy + s*0.7); }
  else if(player.dir==="E"){ ctx.moveTo(cx + s, cy); ctx.lineTo(cx - s*0.7, cy - s*0.75); ctx.lineTo(cx - s*0.7, cy + s*0.75); }
  else if(player.dir==="S"){ ctx.moveTo(cx, cy + s); ctx.lineTo(cx - s*0.75, cy - s*0.7); ctx.lineTo(cx + s*0.75, cy - s*0.7); }
  else { ctx.moveTo(cx - s, cy); ctx.lineTo(cx + s*0.7, cy - s*0.75); ctx.lineTo(cx + s*0.7, cy + s*0.75); }
  ctx.closePath(); ctx.fill();
  ctx.restore();

  ctx.fillStyle = "#6b7280";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(`–®–∞–≥: ${ip}/${actionsQueue.length}`, 12, canvas.height - 12);
}

function usedLoopBlocks(){
  const blocks = workspace.getAllBlocks(false);
  const loopTypes = new Set(["maze_repeat_times","maze_until_goal"]);
  return blocks.some(b => loopTypes.has(b.type));
}
function calcStars(actionsCount, parActions){
  const par = Math.max(1, Number(parActions||1));
  const r = actionsCount / par;
  if (r <= 1.00) return 5;
  if (r <= 1.25) return 4;
  if (r <= 1.60) return 3;
  if (r <= 2.20) return 2;
  return 1;
}
function compileProgram(throwOnEmpty=true){
  api._ticks = 0;
  const code = Blockly.JavaScript.workspaceToCode(workspace);
  const actions = [];
  const fn = new Function("actions","api", `"use strict";\n${code}\nreturn actions;`);
  let out;
  try { out = fn(actions, api); }
  catch(e){ throw new Error("–û—à–∏–±–∫–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ: " + e.message); }

  if(throwOnEmpty && (!out || out.length===0)) throw new Error("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—É—Å—Ç–∞—è: –¥–æ–±–∞–≤—å –±–ª–æ–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è.");
  if(out.length > 2500) throw new Error("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–æ–º–∞–Ω–¥. –£–ø—Ä–æ—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É.");
  return {code, actions: out};
}
function enforceLevelRules(level, actionsCount){
  const blocksCount = workspace.getAllBlocks(false).length;

  if(level.maxBlocks && blocksCount > level.maxBlocks){
    throw new Error(`–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –±–ª–æ–∫–æ–≤: ${blocksCount}. –ù—É–∂–Ω–æ –Ω–µ –±–æ–ª—å—à–µ ${level.maxBlocks}.`);
  }
  if(level.requireLoop && !usedLoopBlocks()){
    throw new Error("–ù–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π —Ü–∏–∫–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–ø–æ–≤—Ç–æ—Ä–∏—Ç—å ‚Ä¶ —Ä–∞–∑¬ª).");
  }
  if(Number.isFinite(level.maxCommands) && actionsCount > level.maxCommands){
    throw new Error(`–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–æ–º–∞–Ω–¥: ${actionsCount}. –ù—É–∂–Ω–æ –Ω–µ –±–æ–ª—å—à–µ ${level.maxCommands}.`);
  }
}

function updateStarsBadge(){
  const L = getAllLevels()[levelIndex];
  const best = getBestStars(L.id);
  $("starsText").textContent = best ? ("‚òÖ".repeat(best) + "‚òÜ".repeat(5-best)) : "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
}
function updateTopTexts(){
  const L = getAllLevels()[levelIndex];
  $("leftSub").textContent = L.subtitle || "–î–æ–±–µ—Ä–∏—Å—å –¥–æ —Ü–µ–ª–∏!";
  $("goalPill").textContent = "–ó–∞–¥–∞–Ω–∏–µ: " + (L.goal || "‚Äî");

  const parts = [];
  if(L.maxBlocks) parts.push(`–º–∞–∫—Å. –±–ª–æ–∫–æ–≤ ${L.maxBlocks}`);
  if(Number.isFinite(L.maxCommands)) parts.push(`–º–∞–∫—Å. –∫–æ–º–∞–Ω–¥ ${L.maxCommands}`);
  if(L.requireLoop) parts.push("–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω —Ü–∏–∫–ª");
  $("limitPill").textContent = "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: " + (parts.length ? parts.join(", ") : "–Ω–µ—Ç");

  $("minPill").textContent = `–ú–∏–Ω–∏–º—É–º: ${L.minCommands} –∫–æ–º–∞–Ω–¥`;
  updateStarsBadge();
}
function initLevelSelect(){
  const sel = $("levelSelect");
  sel.innerHTML = "";
  const levels = getAllLevels();
  const progress = loadProgress();

  levels.forEach((L, idx)=>{
    const locked = (L.id > progress.unlocked);
    const best = getBestStars(L.id);
    const stars = best ? ("‚òÖ".repeat(best) + "‚òÜ".repeat(5-best)) : "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.disabled = locked;
    opt.textContent = `${L.title}${locked ? " üîí" : ""}${best ? " ‚Ä¢ " + stars : ""}`;
    sel.appendChild(opt);
  });

  const cur = levels[levelIndex]?.id || 1;
  if(cur > progress.unlocked) levelIndex = Math.max(0, progress.unlocked - 1);
  sel.value = String(levelIndex);
}

/* Starter blocks */
function renderBlock(b){
  try{ if (typeof b.initSvg === "function") b.initSvg(); if (typeof b.render === "function") b.render(); }catch{}
}
function addStarterBlocks(level){
  if(level.toolbox === "move"){
    const b = workspace.newBlock("maze_move_forward");
    b.moveBy(40, 40);
    renderBlock(b);
    return;
  }
  if(level.toolbox === "turn"){
    const b1 = workspace.newBlock("maze_move_forward");
    const b2 = workspace.newBlock("maze_turn_right");
    b1.moveBy(40,40);
    b2.moveBy(40,120);
    renderBlock(b1); renderBlock(b2);
    try{ b1.nextConnection.connect(b2.previousConnection); }catch{}
    return;
  }
  if(level.toolbox === "repeat"){
    const rep = workspace.newBlock("maze_repeat_times");
    rep.setFieldValue(4, "COUNT");
    rep.moveBy(40,40);
    renderBlock(rep);
    const f = workspace.newBlock("maze_move_forward");
    f.moveBy(70,120);
    renderBlock(f);
    try{
      const doConn = rep.getInput("DO")?.connection;
      if(doConn && f.previousConnection) doConn.connect(f.previousConnection);
    }catch{}
    return;
  }
  const rep = workspace.newBlock("maze_until_goal");
  rep.moveBy(40,40);
  renderBlock(rep);

  const cond = workspace.newBlock("maze_if_path");
  cond.moveBy(70,120);
  renderBlock(cond);

  const f = workspace.newBlock("maze_move_forward");
  f.moveBy(100,200);
  renderBlock(f);

  try{
    const doConn1 = rep.getInput("DO")?.connection;
    if(doConn1 && cond.previousConnection) doConn1.connect(cond.previousConnection);
    const doConn2 = cond.getInput("DO")?.connection;
    if(doConn2 && f.previousConnection) doConn2.connect(f.previousConnection);
  }catch{}
}

function stopRun(){
  running = false;
  if(timer){ clearInterval(timer); timer=null; }
}
function resetGame(clearBlocks=false){
  stopRun();
  player = {...start};
  actionsQueue = [];
  ip = 0;
  setStatus("–ì–æ—Ç–æ–≤–æ");
  if(clearBlocks){
    workspace.clear();
    addStarterBlocks(getAllLevels()[levelIndex]);
  }
  draw();
}
function applyAction(a){
  if(a.t==="L"){ player.dir = DIRS[(DIRS.indexOf(player.dir)+3)%4]; return true; }
  if(a.t==="R"){ player.dir = DIRS[(DIRS.indexOf(player.dir)+1)%4]; return true; }
  if(a.t==="F"){
    if(!api.isPathForward()){
      setMsg("err", "–¢—ã –≤—Ä–µ–∑–∞–ª—Å—è –≤ —Å—Ç–µ–Ω—É. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–≤–æ—Ä–æ—Ç—ã, –∞ –Ω–∞ —Å–ª–æ–∂–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö ‚Äî —É—Å–ª–æ–≤–∏–µ ¬´–µ—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ —Å–≤–æ–±–æ–¥–Ω–æ¬ª.");
      setStatus("–°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ");
      stopRun();
      return false;
    }
    const [dx,dy] = VEC[player.dir];
    player.x += dx; player.y += dy;
    return true;
  }
  return true;
}

function showFinishModal(){ $("finishModal").style.display="flex"; }
function hideFinishModal(){ $("finishModal").style.display="none"; }

function checkWin(){
  if(api.isAtGoal()){
    const L = getAllLevels()[levelIndex];
    const stars = calcStars(ip, L.parActions);
    setBestStars(L.id, stars);
    unlockNextLevel(L.id);

    setMsg("ok", `–ü–æ–±–µ–¥–∞! –û—Ü–µ–Ω–∫–∞: ${"‚òÖ".repeat(stars)}${"‚òÜ".repeat(5-stars)} (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)`);
    setStatus("–ü–æ–±–µ–¥–∞");

    updateStarsBadge();
    initLevelSelect();

    const levels = getAllLevels();
    const lastId = levels[levels.length-1].id;
    if(L.id === lastId){
      markFinishedAll();
      showFinishModal();
    }
    stopRun();
    return true;
  }
  return false;
}
function stepOnce(){
  if(ip >= actionsQueue.length){
    setMsg("warn", "–ö–æ–º–∞–Ω–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –î–æ–±–∞–≤—å –±–ª–æ–∫–∏ –∏–ª–∏ —É–ª—É—á—à–∞–π –∞–ª–≥–æ—Ä–∏—Ç–º.");
    setStatus("–û–∫–æ–Ω—á–µ–Ω–æ");
    stopRun();
    return;
  }
  setStatus("–í—ã–ø–æ–ª–Ω—è—é‚Ä¶");
  const ok = applyAction(actionsQueue[ip]);
  ip++;
  draw();
  if(ok) checkWin();
}
function run(){
  stopRun();
  const L = getAllLevels()[levelIndex];
  try{
    const compiled = compileProgram(true);
    enforceLevelRules(L, compiled.actions.length);
    actionsQueue = compiled.actions;
    ip = 0;
  }catch(e){
    setMsg("err", e.message);
    setStatus("–û—à–∏–±–∫–∞");
    return;
  }

  running = true;
  setMsg("info", "–ó–∞–ø—É—Å–∫‚Ä¶ (–º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å ¬´–°–±—Ä–æ—Å¬ª)");
  setStatus("–ó–∞–ø—É—Å–∫");
  timer = setInterval(()=>{ if(running) stepOnce(); }, 230);
}
function step(){
  stopRun();
  const L = getAllLevels()[levelIndex];
  if(actionsQueue.length===0 && ip===0){
    try{
      const compiled = compileProgram(true);
      enforceLevelRules(L, compiled.actions.length);
      actionsQueue = compiled.actions;
    }catch(e){
      setMsg("err", e.message);
      setStatus("–û—à–∏–±–∫–∞");
      return;
    }
  }
  stepOnce();
}
function loadLevel(idx){
  const levels = getAllLevels();
  levelIndex = Math.max(0, Math.min(idx, levels.length-1));
  const L = levels[levelIndex];

  const tbDom = toolboxXmlToDom(toolboxXmlFor(L));
  if(typeof workspace.updateToolbox === "function") workspace.updateToolbox(tbDom);

  parseLevel(L);
  resetGame(true);
  updateTopTexts();
  setMsg("info", `<strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> ${L.hint || "–°–æ–±–µ—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ –∑–∞–ø—É—Å—Ç–∏."}`);
  setStatus("–ì–æ—Ç–æ–≤–æ");
}

/* =========================
   Editor (teacher)
========================= */
function showEditor(){ $("editorModal").style.display="flex"; syncEditorFromSelected(); syncEditorJson(); }
function hideEditor(){ $("editorModal").style.display="none"; }

function parseGridText(txt){
  const lines = txt.split("\n").map(s=>s.trim()).filter(Boolean);
  if(lines.length < 3) throw new Error("–°–µ—Ç–∫–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∞—è.");
  const len = lines[0].length;
  if(!lines.every(r=>r.length===len)) throw new Error("–í—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å–µ—Ç–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–Ω–æ–π –¥–ª–∏–Ω—ã.");
  const joined = lines.join("\n");
  if(!joined.includes("S")) throw new Error("–ù—É–∂–Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∫–ª–µ—Ç–∫–∞ S.");
  if(!joined.includes("G")) throw new Error("–ù—É–∂–Ω–∞ —Ü–µ–ª—å G.");
  const valid = new Set(["#",".","S","G"]);
  for(const r of lines){
    for(const ch of r){
      if(!valid.has(ch)) throw new Error(`–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Å–∏–º–≤–æ–ª ¬´${ch}¬ª. –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ # . S G`);
    }
  }
  return lines;
}
function getSelectedLevelIndex(){ return Number($("levelSelect").value || 0); }

function syncEditorFromSelected(){
  const L = getAllLevels()[getSelectedLevelIndex()];
  if(!L) return;
  $("edTitle").value = L.title || "";
  $("edGoal").value = L.goal || "";
  $("edHint").value = L.hint || "";
  $("edRequireLoop").checked = !!L.requireLoop;
  $("edMaxBlocks").value = L.maxBlocks ?? "";
  $("edMaxCommands").value = L.maxCommands ?? "";
  $("edParActions").value = L.parActions ?? "";
  $("edGrid").value = (L.grid || []).join("\n");
}
function collectEditorLevel(requireValidGrid=true){
  const title = ($("edTitle").value || "").trim() || "–£—Ä–æ–≤–µ–Ω—å";
  const goalT  = ($("edGoal").value || "").trim()  || "–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.";
  const hintT  = ($("edHint").value || "").trim()  || "";
  const requireLoop = $("edRequireLoop").checked;
  const maxBlocks = $("edMaxBlocks").value === "" ? undefined : Number($("edMaxBlocks").value);
  const maxCommands = $("edMaxCommands").value === "" ? undefined : Number($("edMaxCommands").value);
  const parActions = $("edParActions").value === "" ? undefined : Number($("edParActions").value);
  const gridLines = requireValidGrid ? parseGridText($("edGrid").value)
                                     : $("edGrid").value.split("\n").map(s=>s.trim()).filter(Boolean);

  const cur = getAllLevels()[getSelectedLevelIndex()];
  return {
    title,
    subtitle: cur.subtitle || "–£—Ä–æ–≤–µ–Ω—å",
    goal: goalT,
    hint: hintT,
    requireLoop,
    maxBlocks,
    maxCommands,
    parActions,
    toolbox: cur.toolbox || "turn",
    grid: gridLines
  };
}
function syncEditorJson(){
  try{
    const obj = collectEditorLevel(false);
    $("edJson").value = JSON.stringify(obj, null, 2);
  }catch{}
}
function saveEditsToCurrentLevel(){
  const idx = getSelectedLevelIndex();
  const current = getAllLevels()[idx];
  if(!current) return;

  const updated = collectEditorLevel(true);
  const min = shortestCommands(updated);
  if(!Number.isFinite(min) || min===Infinity) throw new Error("–õ–∞–±–∏—Ä–∏–Ω—Ç –Ω–µ –∏–º–µ–µ—Ç —Ä–µ—à–µ–Ω–∏—è (—Ü–µ–ª—å –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–∞).");
  updated.minCommands = min;

  if(updated.maxCommands !== undefined) updated.maxCommands = Math.max(updated.maxCommands, min);

  const baseCount = TUTOR_LEVELS.length + GENERATED_LEVELS.length;
  const isCustom = current.id > baseCount;

  if(isCustom){
    const custom = loadCustomLevels();
    const i = custom.findIndex(x=>x.id === current.id);
    if(i === -1) throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.");
    custom[i] = { ...custom[i], ...updated, id: current.id };
    saveCustomLevels(custom);
  }else{
    const overrides = loadOverrides();
    overrides[String(current.id)] = {
      title: updated.title,
      goal: updated.goal,
      hint: updated.hint,
      requireLoop: updated.requireLoop,
      maxBlocks: updated.maxBlocks,
      maxCommands: updated.maxCommands,
      parActions: updated.parActions,
      grid: updated.grid,
    };
    saveOverrides(overrides);
  }

  setMsg("ok", "–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ (–Ω–µ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π).");
  initLevelSelect();
  loadLevel(idx);
  syncEditorFromSelected();
  syncEditorJson();
}
function recalcCriteriaForEditor(){
  const tmp = collectEditorLevel(true);
  const min = shortestCommands(tmp);
  if(!Number.isFinite(min) || min===Infinity) throw new Error("–õ–∞–±–∏—Ä–∏–Ω—Ç –Ω–µ –∏–º–µ–µ—Ç —Ä–µ—à–µ–Ω–∏—è (—Ü–µ–ª—å –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–∞).");

  const slack = (min<=12) ? 2 : (min<=40) ? 6 : 10;
  $("edParActions").value = min;
  $("edMaxCommands").value = min + slack;
  setMsg("ok", `–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ: –º–∏–Ω–∏–º—É–º ${min}, —Ä–µ–∫–æ–º–µ–Ω–¥. –º–∞–∫—Å. –∫–æ–º–∞–Ω–¥ ${min+slack}.`);
  syncEditorJson();
}
function previewEditorLevel(){
  const tmp = normalizeCriteria(collectEditorLevel(true));
  parseLevel(tmp);
  resetGame(false);
  draw();
  setMsg("info", "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∫—Ä—ã—Ç (–µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ).");
}
function exportEditorJson(){
  const obj = collectEditorLevel(true);
  $("edJson").value = JSON.stringify(obj, null, 2);
  setMsg("ok", "–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤: JSON –≤ –ø–æ–ª–µ –Ω–∏–∂–µ.");
}
function importEditorJson(){
  const obj = JSON.parse($("edJson").value);
  if(!obj || typeof obj !== "object") throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π JSON.");
  if(!Array.isArray(obj.grid)) throw new Error("–ù—É–∂–Ω–æ –ø–æ–ª–µ grid: –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫.");
  parseGridText(obj.grid.join("\n"));

  $("edTitle").value = obj.title || "–£—Ä–æ–≤–µ–Ω—å";
  $("edGoal").value = obj.goal || "–î–æ–π–¥–∏ –¥–æ —Ü–µ–ª–∏.";
  $("edHint").value = obj.hint || "";
  $("edRequireLoop").checked = !!obj.requireLoop;
  $("edMaxBlocks").value = obj.maxBlocks ?? "";
  $("edMaxCommands").value = obj.maxCommands ?? "";
  $("edParActions").value = obj.parActions ?? "";
  $("edGrid").value = obj.grid.join("\n");
  setMsg("ok", "–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è¬ª.");
}
function resetEditsForCurrentLevel(){
  const idx = getSelectedLevelIndex();
  const current = getAllLevels()[idx];
  if(!current) return;
  clearOverrideFor(current.id);
  setMsg("ok", "–ü—Ä–∞–≤–∫–∏ —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è —Å–±—Ä–æ—à–µ–Ω—ã.");
  initLevelSelect();
  loadLevel(idx);
  syncEditorFromSelected();
  syncEditorJson();
}

/* =========================
   Workspace info
========================= */
workspace.addChangeListener(()=>{
  const blocks = workspace.getAllBlocks(false).length;
  $("blocksInfo").textContent = "–ë–ª–æ–∫–æ–≤: " + blocks;
  try{
    const compiled = compileProgram(false);
    $("actionsInfo").textContent = "–ö–æ–º–∞–Ω–¥: " + compiled.actions.length;
  }catch{
    $("actionsInfo").textContent = "–ö–æ–º–∞–Ω–¥: ‚Äî";
  }
});

/* =========================
   Events
========================= */
$("levelSelect").addEventListener("change", e => loadLevel(Number(e.target.value)));
$("runBtn").addEventListener("click", run);
$("stepBtn").addEventListener("click", step);
$("resetBtn").addEventListener("click", ()=> resetGame(false));

$("showCodeBtn").addEventListener("click", ()=>{
  try{
    const {code} = compileProgram(false);
    alert(code.trim() ? code : "(–ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–¥–∞ ‚Äî –¥–æ–±–∞–≤—å –±–ª–æ–∫–∏)");
  }catch(e){ alert("–û—à–∏–±–∫–∞: " + e.message); }
});

/* Editor PIN gate: —Å–ø—Ä–∞—à–∏–≤–∞–µ–º PIN –∫–∞–∂–¥—ã–π —Ä–∞–∑ */
$("editorOpenBtn").addEventListener("click", ()=>{
  if(!requireTeacher()) return;
  showEditor();
});
$("editorCloseBtn").addEventListener("click", hideEditor);

$("edSaveBtn").addEventListener("click", ()=>{
  try{ saveEditsToCurrentLevel(); }
  catch(e){ setMsg("err", "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: " + e.message); }
});
$("edRecalcBtn").addEventListener("click", ()=>{
  try{ recalcCriteriaForEditor(); }
  catch(e){ setMsg("err", "–ü–µ—Ä–µ—Å—á—ë—Ç: " + e.message); }
});
$("edResetOverridesBtn").addEventListener("click", ()=>{
  try{ resetEditsForCurrentLevel(); }
  catch(e){ setMsg("err", "–°–±—Ä–æ—Å: " + e.message); }
});
$("edPreviewBtn").addEventListener("click", ()=>{
  try{ previewEditorLevel(); }
  catch(e){ setMsg("err", "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: " + e.message); }
});
$("edExportBtn").addEventListener("click", ()=>{
  try{ exportEditorJson(); }
  catch(e){ setMsg("err", "–≠–∫—Å–ø–æ—Ä—Ç: " + e.message); }
});
$("edImportBtn").addEventListener("click", ()=>{
  try{ importEditorJson(); }
  catch(e){ setMsg("err", "–ò–º–ø–æ—Ä—Ç: " + e.message); }
});

/* ‚úÖ –°–º–µ–Ω–∞ PIN –≤ —Ä–µ–∂–∏–º–µ —É—á–∏—Ç–µ–ª—è */
$("changePinBtn").addEventListener("click", ()=>{
  const cur = prompt("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π PIN:");
  if(cur === null) return;
  if(String(cur) !== getTeacherPin()){
    alert("–¢–µ–∫—É—â–∏–π PIN –Ω–µ–≤–µ—Ä–Ω—ã–π.");
    return;
  }

  const p1 = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π PIN (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞):");
  if(p1 === null) return;
  const np = String(p1).trim();
  if(np.length < 4){
    alert("PIN —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.");
    return;
  }

  const p2 = prompt("–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π PIN:");
  if(p2 === null) return;
  if(String(p2).trim() !== np){
    alert("PIN –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.");
    return;
  }

  setTeacherPin(np);
  alert("PIN —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω.");
});

$("editorHelpBtn").addEventListener("click", ()=>{
  alert(
    "–†–µ–¥–∞–∫—Ç–æ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —É—á–∏—Ç–µ–ª—é.\n\n" +
    "‚Ä¢ –ù–∞–∂–º–∏—Ç–µ ¬´üîí –†–µ–¥–∞–∫—Ç–æ—Ä¬ª, –≤–≤–µ–¥–∏—Ç–µ PIN (—Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑).\n" +
    "‚Ä¢ ¬´–°–º–µ–Ω–∏—Ç—å PIN¬ª ‚Äî –º–µ–Ω—è–µ—Ç –ø–∞—Ä–æ–ª—å –Ω–∞ —ç—Ç–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (–≤ –±—Ä–∞—É–∑–µ—Ä–µ).\n" +
    "‚Ä¢ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è¬ª –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å.\n" +
    "‚Ä¢ ¬´–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏¬ª —Å—Ç–∞–≤–∏—Ç –ø–∞—Ä=–º–∏–Ω–∏–º—É–º, –∞ –º–∞–∫—Å. –∫–æ–º–∞–Ω–¥ = –º–∏–Ω–∏–º—É–º + –∑–∞–ø–∞—Å."
  );
});

/* Finish modal */
$("finishCloseBtn").addEventListener("click", hideFinishModal);
$("finishReplayBtn").addEventListener("click", ()=>{
  hideFinishModal();
  const p = loadProgress();
  p.unlocked = 1; p.finishedAll = false;
  saveProgress(p);
  initLevelSelect();
  loadLevel(0);
});

window.addEventListener("resize", ()=> Blockly.svgResize(workspace));

/* =========================
   Init
========================= */
function init(){
  initLevelSelect();
  loadLevel(0);
}
try { init(); } catch(e){ showFatalError(e); }

(function(){
  let t=null;
  function resizeBlockly(){
    try{ Blockly.svgResize(workspace); }catch(e){}
  }
  function schedule(){
    if(t) clearTimeout(t);
    t = setTimeout(resizeBlockly, 150);
  }
  window.addEventListener("orientationchange", schedule);
  window.addEventListener("resize", schedule);
  window.addEventListener("load", schedule);
  // also after fonts/layout settle
  setTimeout(resizeBlockly, 300);
  setTimeout(resizeBlockly, 800);
})();

</script>
</body>
</html>
